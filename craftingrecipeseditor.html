<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crafting Recipes Editor</title>
    <!-- Added Sortable.js for drag & drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(20, 20, 20, 0.8);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 0 40px rgba(255, 255, 255, 0.1);
        }

        h1 {
            text-align: center;
            margin-bottom: 2rem;
            color: #ffffff;
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
            font-size: 2.5rem;
        }

        /* Added search bar for editor */
        .search-bar {
            margin-bottom: 1.5rem;
            position: relative;
        }

        .search-bar input {
            width: 100%;
            padding: 0.8rem 1rem;
            background: rgba(30, 30, 30, 0.9);
            border: 2px solid rgba(100, 200, 255, 0.3);
            border-radius: 8px;
            color: #e0e0e0;
            font-size: 1rem;
        }

        .search-bar input:focus {
            outline: none;
            border-color: rgba(100, 200, 255, 0.6);
            box-shadow: 0 0 20px rgba(100, 200, 255, 0.2);
        }

        .editor-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            padding: 0.8rem 1.5rem;
            background: rgba(100, 200, 255, 0.3);
            color: #ffffff;
            border: 2px solid rgba(100, 200, 255, 0.6);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(100, 200, 255, 0.2);
            font-size: 1rem;
        }

        .btn:hover {
            background: rgba(100, 200, 255, 0.5);
            box-shadow: 0 0 25px rgba(100, 200, 255, 0.4);
            transform: translateY(-2px);
        }

        .btn-success {
            background: rgba(46, 204, 113, 0.3);
            border-color: rgba(46, 204, 113, 0.6);
            box-shadow: 0 0 15px rgba(46, 204, 113, 0.2);
        }

        .btn-success:hover {
            background: rgba(46, 204, 113, 0.5);
            box-shadow: 0 0 25px rgba(46, 204, 113, 0.4);
        }

        .btn-danger {
            background: rgba(231, 76, 60, 0.3);
            border-color: rgba(231, 76, 60, 0.6);
            box-shadow: 0 0 15px rgba(231, 76, 60, 0.2);
        }

        .btn-danger:hover {
            background: rgba(231, 76, 60, 0.5);
            box-shadow: 0 0 25px rgba(231, 76, 60, 0.4);
        }

        .btn-warning {
            background: rgba(255, 193, 7, 0.3);
            border-color: rgba(255, 193, 7, 0.6);
            box-shadow: 0 0 15px rgba(255, 193, 7, 0.2);
        }

        .btn-warning:hover {
            background: rgba(255, 193, 7, 0.5);
            box-shadow: 0 0 25px rgba(255, 193, 7, 0.4);
        }

        /* Added secondary button style */
        .btn-secondary {
            background: rgba(150, 150, 150, 0.3);
            border-color: rgba(150, 150, 150, 0.6);
            box-shadow: 0 0 15px rgba(150, 150, 150, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(150, 150, 150, 0.5);
            box-shadow: 0 0 25px rgba(150, 150, 150, 0.4);
        }

        .editor-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 2rem;
        }

        .sidebar {
            background: rgba(30, 30, 30, 0.9);
            border-radius: 8px;
            padding: 1.5rem;
            max-height: 70vh;
            overflow-y: auto;
        }

        .sidebar h3 {
            color: #ffffff;
            margin-bottom: 1rem;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        }

        .category-list {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
        }

        .category-item {
            padding: 0.8rem;
            background: rgba(40, 40, 40, 0.8);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .category-item:hover {
            background: rgba(50, 50, 50, 0.9);
            border-color: rgba(100, 200, 255, 0.3);
        }

        .category-item.selected {
            border-color: rgba(100, 200, 255, 0.8);
            box-shadow: 0 0 15px rgba(100, 200, 255, 0.3);
        }

        /* Updated category header with action buttons */
        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 0.5rem;
        }

        .category-header-left {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .category-actions {
            display: flex;
            gap: 0.3rem;
        }

        .category-action-btn {
            width: 24px;
            height: 24px;
            background: rgba(60, 60, 60, 0.8);
            border: 1px solid rgba(100, 100, 100, 0.5);
            border-radius: 4px;
            color: #aaa;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .category-action-btn:hover {
            background: rgba(80, 80, 80, 0.9);
            color: #fff;
        }

        .category-action-btn.danger:hover {
            background: rgba(231, 76, 60, 0.5);
            border-color: rgba(231, 76, 60, 0.8);
        }

        .category-count {
            font-size: 0.85rem;
            color: #888;
            background: rgba(100, 200, 255, 0.2);
            padding: 0.2rem 0.5rem;
            border-radius: 3px;
        }

        .item-list {
            margin-left: 1rem;
            margin-top: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        /* Updated item entry with drag handle */
        .item-entry {
            padding: 0.6rem 0.8rem;
            background: rgba(35, 35, 35, 0.8);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            border-left: 2px solid transparent;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .item-entry:hover {
            background: rgba(45, 45, 45, 0.9);
            border-left-color: rgba(100, 200, 255, 0.5);
        }

        .item-entry.selected {
            background: rgba(100, 200, 255, 0.2);
            border-left: 3px solid rgba(100, 200, 255, 0.8);
        }

        .item-entry.hidden {
            display: none;
        }

        .drag-handle {
            cursor: grab;
            color: #666;
            font-size: 1rem;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .item-entry-name {
            flex: 1;
        }

        /* Validation error styling */
        .validation-error {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid rgba(231, 76, 60, 0.5);
            color: #e74c3c;
            padding: 0.8rem 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .validation-error ul {
            margin: 0.5rem 0 0 1.5rem;
        }

        .editor-main {
            background: rgba(30, 30, 30, 0.9);
            border-radius: 8px;
            padding: 2rem;
            max-height: 70vh;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #aaa;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 0.8rem;
            background: rgba(40, 40, 40, 0.8);
            border: 2px solid rgba(100, 200, 255, 0.3);
            border-radius: 6px;
            color: #e0e0e0;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: rgba(100, 200, 255, 0.8);
            box-shadow: 0 0 15px rgba(100, 200, 255, 0.2);
        }

        .form-group input.error,
        .form-group textarea.error {
            border-color: rgba(231, 76, 60, 0.8);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .section-title {
            color: #ffffff;
            font-size: 1.3rem;
            margin: 2rem 0 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid rgba(100, 200, 255, 0.3);
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }

        .stat-input {
            background: rgba(40, 40, 40, 0.6);
            padding: 1rem;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .stat-input:hover {
            border-color: rgba(100, 200, 255, 0.3);
            box-shadow: 0 0 10px rgba(100, 200, 255, 0.1);
        }

        .stat-input label {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 0.3rem;
            display: block;
        }

        .stat-input input {
            margin-bottom: 0.5rem;
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.8rem;
        }

        .stat-name {
            font-weight: 600;
            color: #64c8ff;
        }

        .delete-stat-btn {
            background: rgba(231, 76, 60, 0.3);
            border: 1px solid rgba(231, 76, 60, 0.5);
            color: #e74c3c;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }

        .delete-stat-btn:hover {
            background: rgba(231, 76, 60, 0.5);
        }

        .add-btn {
            background: rgba(100, 200, 255, 0.2);
            border: 2px dashed rgba(100, 200, 255, 0.5);
            color: #64c8ff;
            padding: 0.8rem;
            border-radius: 6px;
            cursor: pointer;
            width: 100%;
            margin-top: 1rem;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

        .add-btn:hover {
            background: rgba(100, 200, 255, 0.3);
            border-color: rgba(100, 200, 255, 0.8);
        }

        .material-entry {
            background: rgba(45, 45, 45, 0.8);
            border: 1px solid rgba(100, 200, 255, 0.2);
            border-radius: 6px;
            padding: 1rem;
            margin-bottom: 1rem;
            position: relative;
            transition: all 0.3s ease;
        }

        .material-entry:hover {
            border-color: rgba(100, 200, 255, 0.4);
            box-shadow: 0 0 15px rgba(100, 200, 255, 0.1);
        }

        .material-entry.nested {
            margin-left: 1.5rem;
            border-left: 3px solid rgba(255, 200, 100, 0.5);
        }

        .material-entry.nested-2 {
            margin-left: 3rem;
            border-left: 3px solid rgba(200, 100, 255, 0.5);
        }

        /* Added styles for material dropdown selector */
        .material-selector {
            background: rgba(40, 40, 40, 0.8);
            border: 2px solid rgba(100, 200, 255, 0.3);
            border-radius: 6px;
            color: #e0e0e0;
            font-size: 1rem;
            transition: all 0.3s ease;
            padding: 0.8rem;
            width: 100%;
            cursor: pointer;
        }

        .material-selector:focus {
            outline: none;
            border-color: rgba(100, 200, 255, 0.8);
            box-shadow: 0 0 15px rgba(100, 200, 255, 0.2);
        }

        .material-selector option {
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 0.5rem;
        }

        .custom-material-toggle {
            margin-top: 0.5rem;
            font-size: 0.85rem;
            color: #64c8ff;
            cursor: pointer;
            display: inline-block;
        }

        .custom-material-toggle:hover {
            text-decoration: underline;
        }

        /* Material header with drag handle */
        .material-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .material-drag-handle {
            cursor: grab;
            color: #666;
            font-size: 1.2rem;
            padding: 0.2rem 0.5rem;
        }

        .material-drag-handle:active {
            cursor: grabbing;
        }

        .remove-btn {
            background: rgba(231, 76, 60, 0.3);
            border: 1px solid rgba(231, 76, 60, 0.5);
            color: #e74c3c;
            padding: 0.4rem 0.8rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }

        .remove-btn:hover {
            background: rgba(231, 76, 60, 0.5);
        }

        .json-output {
            margin-top: 2rem;
            background: rgba(20, 20, 20, 0.9);
            border-radius: 8px;
            padding: 1.5rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .json-output pre {
            color: #64c8ff;
            font-family: 'Consolas', monospace;
            font-size: 0.85rem;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #888;
        }

        .empty-state h3 {
            color: #aaa;
            margin-bottom: 1rem;
        }

        .notification {
            position: fixed;
            top: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            background: rgba(30, 30, 30, 0.95);
            border: 2px solid rgba(100, 200, 255, 0.6);
            border-radius: 8px;
            color: #64c8ff;
            font-size: 0.9rem;
            box-shadow: 0 0 30px rgba(100, 200, 255, 0.3);
            z-index: 2000;
            transform: translateX(400px);
            transition: all 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-color: rgba(46, 204, 113, 0.6);
            color: #2ecc71;
        }

        .notification.error {
            border-color: rgba(231, 76, 60, 0.6);
            color: #e74c3c;
        }

        /* Custom scrollbars */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(20, 20, 20, 0.5);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(100, 200, 255, 0.3);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(100, 200, 255, 0.5);
        }

        /* Added undo/redo indicator */
        .undo-redo-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .undo-redo-btn {
            padding: 0.5rem 0.8rem;
            background: rgba(80, 80, 80, 0.5);
            border: 1px solid rgba(100, 100, 100, 0.5);
            border-radius: 4px;
            color: #aaa;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1rem;
        }

        .undo-redo-btn:hover:not(:disabled) {
            background: rgba(100, 100, 100, 0.6);
            color: #fff;
        }

        .undo-redo-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .history-info {
            font-size: 0.8rem;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Crafting Recipes Editor</h1>

        <!-- Updated search placeholder to English -->
        <div class="search-bar">
            <input type="text" placeholder="Search for items or categories..." oninput="searchEditor(this.value)">
        </div>

        <div class="editor-controls">
            <button class="btn btn-success" onclick="saveData()">üíæ Save to JSON</button>
            <button class="btn" onclick="downloadJSON()">‚¨áÔ∏è Download JSON</button>
            <button class="btn" onclick="addNewItem()">‚ûï Add New Item</button>
            <button class="btn btn-warning" onclick="addNewCategory()">üìÅ Add New Category</button>
            <button class="btn btn-secondary" onclick="duplicateCurrentItem()">üìã Duplicate Item</button>
            <button class="btn btn-danger" onclick="deleteCurrentItem()">üóëÔ∏è Delete Current Item</button>
            
            <!-- Added undo/redo controls -->
            <div class="undo-redo-controls">
                <button class="undo-redo-btn" onclick="undo()" id="undo-btn" disabled title="Undo (Ctrl+Z)">‚Ü∂</button>
                <button class="undo-redo-btn" onclick="redo()" id="redo-btn" disabled title="Redo (Ctrl+Y)">‚Ü∑</button>
                <span class="history-info" id="history-info"></span>
            </div>
        </div>

        <div class="editor-grid">
            <div class="sidebar">
                <h3>Categories & Items</h3>
                <div class="category-list" id="category-list"></div>
            </div>

            <div class="editor-main" id="editor-main">
                <div class="empty-state">
                    <h3>Welcome to the Editor</h3>
                    <p>Select an item from the sidebar to edit, or create a new one</p>
                </div>
            </div>
        </div>

        <div class="json-output">
            <h3 style="color: #ffffff; margin-bottom: 1rem;">JSON Preview</h3>
            <pre id="json-preview">Loading...</pre>
        </div>
    </div>

    <script>
        let gameData = {};
        let currentItem = null;
        let currentCategory = null;
        
        let history = [];
        let historyIndex = -1;
        const MAX_HISTORY = 50;

        const PREDEFINED_MATERIALS = {
            'Cloth': [
                { name: 'Fabric', amount: 1 },
                { name: 'Polyester', amount: 1 }
            ],
            'Iron plate': [
                { name: 'Iron ingot', amount: 1 },
                { name: 'Fabric', amount: 1 },
                { name: 'Polyester', amount: 1 }
            ],
            'Component': [
                { name: 'Iron ingot', amount: 1 },
                { name: 'Copper ingot', amount: 1 }
            ],
            'Tempered glass': [
                { name: 'Glass', amount: 2 },
                { name: 'Polyester', amount: 1 }
            ],
            'Weapon part': [
                { name: 'Iron ingot', amount: 1 },
                { name: 'Copper ingot', amount: 1 }
            ],
            'Stabilizer': [
                { name: 'Iron ingot', amount: 2 },
                { name: 'Gold ingot', amount: 1 }
            ],
            'Attachment part': [
                { name: 'Copper ingot', amount: 2 },
                { name: 'Silver ingot', amount: 1 }
            ],
            'Ammo': [
                { name: 'Iron ingot', amount: 1 },
                { name: 'Charcoal', amount: 1 }
            ],
            'Mechanical component': [
                { name: 'Iron ingot', amount: 2 },
                { name: 'Copper ingot', amount: 2 }
            ],
            'Engine Part': [
                { name: 'Iron ingot', amount: 1 },
                { name: 'Copper ingot', amount: 1 },
                { name: 'Canister (petrol)', amount: 1 }
            ],
            'Interior part': [
                { name: 'Fabric', amount: 2 },
                { name: 'Polyester', amount: 2 }
            ],
            'Rotor': [
                { name: 'Charcoal', amount: 1 },
                { name: 'Polyester', amount: 1 }
            ],
            'Kevlar': [
                { name: 'Iron plate', amount: 1 },
                { name: 'Iron ingot', amount: 20 }
            ],
            'Component (HQ)': [
                { name: 'Component', amount: 2 },
                { name: 'Gold ingot', amount: 15 }
            ],
            'Weapon part (HQ)': [
                { name: 'Weapon part', amount: 3 },
                { name: 'Iron ingot', amount: 15 },
                { name: 'Copper ingot', amount: 16 }
            ],
            'Stabilizer (HQ)': [
                { name: 'Stabilizer', amount: 3 },
                { name: 'Polyester', amount: 15 }
            ],
            'Attachment part (HQ)': [
                { name: 'Attachment part', amount: 3 },
                { name: 'Wooden planks', amount: 15 }
            ],
            'Ammo (HQ)': [
                { name: 'Ammo', amount: 3 },
                { name: 'Canister (petrol)', amount: 1 }
            ],
            'Mechanical component (HQ)': [
                { name: 'Mechanical component', amount: 9 },
                { name: 'Gold ingot', amount: 45 }
            ],
            'Engine part (HQ)': [
                { name: 'Engine Part', amount: 9 },
                { name: 'Copper ingot', amount: 45 },
                { name: 'Canister (petrol)', amount: 45 }
            ],
            'Interior part (HQ)': [
                { name: 'Interior part', amount: 9 },
                { name: 'Wooden planks', amount: 45 }
            ],
            'Rotor (HQ)': [
                { name: 'Rotor', amount: 9 },
                { name: 'Silver ingot', amount: 30 }
            ]
        };

        function expandMaterialRecipe(materialName, multiplier = 1) {
            const recipe = PREDEFINED_MATERIALS[materialName];
            if (!recipe) return null;

            return recipe.map(component => {
                const expandedComponent = {
                    name: component.name,
                    amount: component.amount * multiplier
                };

                // Recursively expand if the component itself is a predefined material
                const nestedRecipe = PREDEFINED_MATERIALS[component.name];
                if (nestedRecipe) {
                    expandedComponent.components = nestedRecipe.map(nested => ({
                        name: nested.name,
                        amount: nested.amount * expandedComponent.amount
                    }));
                }

                return expandedComponent;
            });
        }


        function loadData() {
            try {
                const response = await fetch('data.json');
                gameData = await response.json();
                saveToHistory();
                renderSidebar();
                updateJSONPreview();
                initSortable();
            } catch (error) {
                console.error('Error loading data:', error);
                showNotification('Error loading data. Make sure data.json exists.', 'error');
            }
        }

        function saveToHistory() {
            // Remove any future states if we're not at the end
            history = history.slice(0, historyIndex + 1);
            
            // Add current state
            history.push(JSON.stringify(gameData));
            
            // Limit history size
            if (history.length > MAX_HISTORY) {
                history.shift();
            } else {
                historyIndex++;
            }
            
            updateHistoryButtons();
        }

        function updateHistoryButtons() {
            const undoBtn = document.getElementById('undo-btn');
            const redoBtn = document.getElementById('redo-btn');
            const info = document.getElementById('history-info');
            
            undoBtn.disabled = historyIndex <= 0;
            redoBtn.disabled = historyIndex >= history.length - 1;
            info.textContent = `${historyIndex + 1}/${history.length}`;
        }

        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                gameData = JSON.parse(history[historyIndex]);
                renderSidebar();
                renderEditor();
                updateJSONPreview();
                updateHistoryButtons();
                showNotification('Undo', 'success');
            }
        }

        function redo() {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                gameData = JSON.parse(history[historyIndex]);
                renderSidebar();
                renderEditor();
                updateJSONPreview();
                updateHistoryButtons();
                showNotification('Redo', 'success');
            }
        }

        // Keyboard shortcuts for undo/redo
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 'z' && !e.shiftKey) {
                    e.preventDefault();
                    undo();
                } else if (e.key === 'y' || (e.key === 'z' && e.shiftKey)) {
                    e.preventDefault();
                    redo();
                }
            }
        });

        function searchEditor(query) {
            query = query.toLowerCase().trim();
            const items = document.querySelectorAll('.item-entry');
            const categories = document.querySelectorAll('.category-item');
            
            items.forEach(item => {
                const name = item.querySelector('.item-entry-name').textContent.toLowerCase();
                const matches = query === '' || name.includes(query);
                item.classList.toggle('hidden', !matches);
            });
            
            // Hide categories with no visible items
            categories.forEach(cat => {
                const catName = cat.querySelector('.category-header-left strong').textContent.toLowerCase();
                const visibleItems = cat.querySelectorAll('.item-entry:not(.hidden)');
                const catMatches = query === '' || catName.includes(query);
                cat.style.display = (catMatches || visibleItems.length > 0) ? 'block' : 'none';
            });
        }

        function initSortable() {
            // Make item lists sortable
            document.querySelectorAll('.item-list').forEach((list, catIndex) => {
                new Sortable(list, {
                    animation: 150,
                    handle: '.drag-handle',
                    ghostClass: 'sortable-ghost',
                    onEnd: (evt) => {
                        const fromIndex = evt.oldIndex;
                        const toIndex = evt.newIndex;
                        
                        if (fromIndex !== toIndex) {
                            const items = gameData.categories[catIndex].items;
                            const [moved] = items.splice(fromIndex, 1);
                            items.splice(toIndex, 0, moved);
                            
                            saveToHistory();
                            updateJSONPreview();
                            showNotification('Item neu sortiert', 'success');
                        }
                    }
                });
            });
        }

        function showNotification(message, type = 'success') {
            const existing = document.querySelector('.notification');
            if (existing) existing.remove();
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 10);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 2500);
        }

        function renderSidebar() {
            const container = document.getElementById('category-list');
            container.innerHTML = '';

            gameData.categories.forEach((category, catIndex) => {
                const catDiv = document.createElement('div');
                catDiv.className = 'category-item';
                catDiv.innerHTML = `
                    <div class="category-header">
                        <div class="category-header-left">
                            <strong>${category.name}</strong>
                            <span class="category-count">${category.items.length} items</span>
                        </div>
                        <div class="category-actions">
                            <button class="category-action-btn" onclick="renameCategory(${catIndex}, event)" title="Umbenennen">‚úèÔ∏è</button>
                            <button class="category-action-btn danger" onclick="deleteCategory(${catIndex}, event)" title="L√∂schen">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
                
                const itemList = document.createElement('div');
                itemList.className = 'item-list';
                itemList.setAttribute('data-category', catIndex);
                
                category.items.forEach((item, itemIndex) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'item-entry';
                    if (currentCategory === catIndex && currentItem === itemIndex) {
                        itemDiv.classList.add('selected');
                    }
                    itemDiv.innerHTML = `
                        <span class="drag-handle">‚ãÆ‚ãÆ</span>
                        <span class="item-entry-name">${item.name}</span>
                    `;
                    itemDiv.onclick = () => selectItem(catIndex, itemIndex);
                    itemList.appendChild(itemDiv);
                });
                
                catDiv.appendChild(itemList);
                container.appendChild(catDiv);
            });
            
            // Re-initialize sortable after re-rendering
            setTimeout(initSortable, 100);
        }

        function renameCategory(catIndex, event) {
            event.stopPropagation();
            const category = gameData.categories[catIndex];
            const newName = prompt('Neuer Kategorie-Name:', category.name);
            
            if (newName && newName.trim()) {
                category.name = newName.trim();
                saveToHistory();
                renderSidebar();
                updateJSONPreview();
                showNotification(`Kategorie umbenannt zu "${newName}"`, 'success');
            }
        }

        function deleteCategory(catIndex, event) {
            event.stopPropagation();
            const category = gameData.categories[catIndex];
            
            if (category.items.length > 0) {
                if (!confirm(`Kategorie "${category.name}" hat ${category.items.length} Items. Trotzdem l√∂schen?`)) {
                    return;
                }
            } else if (!confirm(`Kategorie "${category.name}" wirklich l√∂schen?`)) {
                return;
            }
            
            gameData.categories.splice(catIndex, 1);
            
            // Reset selection if deleted category was selected
            if (currentCategory === catIndex) {
                currentCategory = null;
                currentItem = null;
                document.getElementById('editor-main').innerHTML = '<div class="empty-state"><h3>Kategorie gel√∂scht</h3><p>W√§hle ein anderes Item zum Bearbeiten</p></div>';
            } else if (currentCategory > catIndex) {
                currentCategory--;
            }
            
            saveToHistory();
            renderSidebar();
            updateJSONPreview();
            showNotification(`Kategorie "${category.name}" gel√∂scht`, 'success');
        }

        function selectItem(catIndex, itemIndex) {
            currentCategory = catIndex;
            currentItem = itemIndex;
            
            renderSidebar();
            renderEditor();
        }

        function validateItem(item) {
            const errors = [];
            
            if (!item.name || item.name.trim() === '') {
                errors.push('Name is required');
            }
            
            if (!item.id || item.id.trim() === '') {
                errors.push('ID is required');
            }
            
            // Check for duplicate ID
            let idCount = 0;
            gameData.categories.forEach(cat => {
                cat.items.forEach(i => {
                    if (i.id === item.id) idCount++;
                });
            });
            if (idCount > 1) {
                errors.push('ID is already in use');
            }
            
            return errors;
        }

        function renderEditor() {
            if (currentCategory === null || currentItem === null) return;

            const item = gameData.categories[currentCategory].items[currentItem];
            const editorMain = document.getElementById('editor-main');
            
            // Validate and show errors
            const errors = validateItem(item);
            const errorHTML = errors.length > 0 ? `
                <div class="validation-error">
                    <strong>Validation Errors:</strong>
                    <ul>${errors.map(e => `<li>${e}</li>`).join('')}</ul>
                </div>
            ` : '';

            let statsHTML = '';
            for (const [key, stat] of Object.entries(item.stats)) {
                statsHTML += `
                    <div class="stat-input">
                        <div class="stat-header">
                            <span class="stat-name">${key}</span>
                            <button class="delete-stat-btn" onclick="deleteStat('${key}')">‚úï</button>
                        </div>
                        <label>Value</label>
                        <input type="number" value="${stat.value}" onchange="updateStat('${key}', 'value', this.value)">
                        <label>Max</label>
                        <input type="number" value="${stat.max}" onchange="updateStat('${key}', 'max', this.value)">
                        <label>Unit</label>
                        <input type="text" value="${stat.unit || ''}" onchange="updateStat('${key}', 'unit', this.value)">
                    </div>
                `;
            }

            editorMain.innerHTML = `
                ${errorHTML}
                <div class="form-group">
                    <label>Item ID</label>
                    <input type="text" value="${item.id}" onchange="updateField('id', this.value)" class="${errors.some(e => e.includes('ID')) ? 'error' : ''}">
                </div>
                <div class="form-group">
                    <label>Name</label>
                    <input type="text" value="${item.name}" onchange="updateField('name', this.value)" class="${errors.some(e => e.includes('Name')) ? 'error' : ''}">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea onchange="updateField('description', this.value)">${item.description || ''}</textarea>
                </div>
                <div class="form-group">
                    <label>Icon URL</label>
                    <input type="text" value="${item.icon || ''}" onchange="updateField('icon', this.value)" placeholder="https://example.com/icon.png">
                    ${item.icon ? `<img src="${item.icon}" style="max-width: 50px; margin-top: 0.5rem; border-radius: 4px;">` : ''}
                </div>
                <div class="form-group">
                    <label>Image URL</label>
                    <input type="text" value="${item.image || ''}" onchange="updateField('image', this.value)" placeholder="https://example.com/image.png">
                    ${item.image ? `<img src="${item.image}" style="max-width: 150px; margin-top: 0.5rem; border-radius: 4px;">` : ''}
                </div>

                <h4 class="section-title">Stats</h4>
                <div class="stats-grid">${statsHTML}</div>
                <button class="add-btn" onclick="addStat()">‚ûï Add Stat</button>

                <h4 class="section-title">Crafting Materials</h4>
                <div id="materials-container">
                    ${renderCraftingEditor(item.crafting?.direct || [], 0, '')}
                </div>
                <button class="add-btn" onclick="addMaterial()">‚ûï Add Material</button>
            `;
            
            initMaterialsSortable();
        }

        function initMaterialsSortable() {
            const container = document.getElementById('materials-container');
            if (container) {
                new Sortable(container, {
                    animation: 150,
                    handle: '.material-drag-handle',
                    ghostClass: 'sortable-ghost',
                    onEnd: (evt) => {
                        const item = gameData.categories[currentCategory].items[currentItem];
                        const materials = item.crafting.direct;
                        const [moved] = materials.splice(evt.oldIndex, 1);
                        materials.splice(evt.newIndex, 0, moved);
                        
                        saveToHistory();
                        renderEditor();
                        updateJSONPreview();
                    }
                });
            }
        }

        function renderCraftingEditor(materials, level = 0, path = '') {
            if (!materials || materials.length === 0) return '<p style="color: #888;">No materials yet</p>';
            
            let html = '';
            materials.forEach((material, index) => {
                const currentPath = path ? `${path}.${index}` : `${index}`;
                const nestClass = level === 0 ? '' : level === 1 ? 'nested' : 'nested-2';
                
                html += `
                    <div class="material-entry ${nestClass}">
                        <div class="material-header">
                            <span class="material-drag-handle">‚ãÆ‚ãÆ</span>
                            <button class="remove-btn" onclick="removeMaterial('${currentPath}')">‚úï Remove</button>
                        </div>
                        <div class="form-group">
                            <label>Material Name</label>
                            <input type="text" value="${material.name}" onchange="updateMaterial('${currentPath}', 'name', this.value)">
                        </div>
                        <div class="form-group">
                            <label>Amount</label>
                            <input type="number" value="${material.amount}" onchange="updateMaterial('${currentPath}', 'amount', this.value)">
                        </div>
                        ${material.description !== undefined ? `
                        <div class="form-group">
                            <label>Description</label>
                            <input type="text" value="${material.description || ''}" onchange="updateMaterial('${currentPath}', 'description', this.value)">
                        </div>` : ''}
                `;
                
                if (material.components && material.components.length > 0) {
                    html += `
                        <div style="margin-top: 1rem;">
                            <strong style="color: #ccc;">Components:</strong>
                            ${renderCraftingEditor(material.components, level + 1, currentPath + '.components')}
                            <button class="add-btn" onclick="addSubMaterial('${currentPath}')">‚ûï Add Component</button>
                        </div>
                    `;
                } else {
                    html += `<button class="add-btn" onclick="addSubMaterial('${currentPath}')">‚ûï Add Components</button>`;
                }
                
                html += `</div>`;
            });
            
            return html;
        }

        function updateField(field, value) {
            const item = gameData.categories[currentCategory].items[currentItem];
            item[field] = value;
            saveToHistory();
            updateJSONPreview();
            renderSidebar();
        }

        function updateStat(statKey, field, value) {
            const item = gameData.categories[currentCategory].items[currentItem];
            if (!item.stats[statKey]) item.stats[statKey] = {};
            item.stats[statKey][field] = field === 'unit' ? value : Number(value);
            saveToHistory();
            updateJSONPreview();
        }

        function deleteStat(statKey) {
            if (!confirm(`Delete stat "${statKey}"?`)) return;
            const item = gameData.categories[currentCategory].items[currentItem];
            delete item.stats[statKey];
            saveToHistory();
            renderEditor();
            updateJSONPreview();
            showNotification(`Stat "${statKey}" deleted`);
        }

        function updateMaterial(path, field, value) {
            const item = gameData.categories[currentCategory].items[currentItem];
            const parts = path.split('.');
            let target = item.crafting.direct;
            
            for (let i = 0; i < parts.length - 1; i++) {
                if (parts[i] === 'components') {
                    target = target.components;
                } else {
                    const idx = Number(parts[i]);
                    target = target[idx];
                    if (i + 1 < parts.length && parts[i + 1] === 'components') {
                        i++;
                        target = target.components;
                    }
                }
            }
            
            const finalIndex = Number(parts[parts.length - 1]);
            target[finalIndex][field] = field === 'amount' ? Number(value) : value;
            saveToHistory();
            updateJSONPreview();
        }

        function addStat() {
            const statName = prompt('Enter stat name:');
            if (!statName) return;
            
            const item = gameData.categories[currentCategory].items[currentItem];
            if (item.stats[statName]) {
                showNotification('Stat already exists', 'error');
                return;
            }
            
            item.stats[statName] = { value: 0, max: 100, unit: '' };
            saveToHistory();
            renderEditor();
            updateJSONPreview();
            showNotification(`Stat "${statName}" added`);
        }

        function addMaterial() {
            const item = gameData.categories[currentCategory].items[currentItem];
            if (!item.crafting) item.crafting = {};
            if (!item.crafting.direct) item.crafting.direct = [];
            
            const materialOptions = Object.keys(PREDEFINED_MATERIALS).sort();
            let optionsHTML = materialOptions.map(mat => `<option value="${mat}">${mat}</option>`).join('');
            
            const dialogHTML = `
                <div style="background: rgba(30, 30, 30, 0.98); padding: 2rem; border-radius: 8px; border: 2px solid rgba(100, 200, 255, 0.6); max-width: 500px;">
                    <h3 style="color: #fff; margin-bottom: 1rem;">Add Material</h3>
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; color: #aaa; margin-bottom: 0.5rem;">Select Predefined Material</label>
                        <select id="material-select" class="material-selector">
                            <option value="">-- Select Material --</option>
                            ${optionsHTML}
                        </select>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; color: #aaa; margin-bottom: 0.5rem;">Amount</label>
                        <input type="number" id="material-amount" value="1" min="1" style="width: 100%; padding: 0.8rem; background: rgba(40, 40, 40, 0.8); border: 2px solid rgba(100, 200, 255, 0.3); border-radius: 6px; color: #e0e0e0;">
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <span class="custom-material-toggle" onclick="toggleCustomMaterial()">Or enter custom material name</span>
                    </div>
                    <div id="custom-material-input" style="display: none; margin-bottom: 1rem;">
                        <label style="display: block; color: #aaa; margin-bottom: 0.5rem;">Custom Material Name</label>
                        <input type="text" id="custom-material-name" placeholder="Enter custom material name" style="width: 100%; padding: 0.8rem; background: rgba(40, 40, 40, 0.8); border: 2px solid rgba(100, 200, 255, 0.3); border-radius: 6px; color: #e0e0e0;">
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button onclick="closeMaterialDialog()" style="padding: 0.8rem 1.5rem; background: rgba(150, 150, 150, 0.3); border: 2px solid rgba(150, 150, 150, 0.6); border-radius: 6px; color: #fff; cursor: pointer;">Cancel</button>
                        <button onclick="confirmAddMaterial()" style="padding: 0.8rem 1.5rem; background: rgba(100, 200, 255, 0.3); border: 2px solid rgba(100, 200, 255, 0.6); border-radius: 6px; color: #fff; cursor: pointer;">Add Material</button>
                    </div>
                </div>
            `;
            
            const overlay = document.createElement('div');
            overlay.id = 'material-dialog-overlay';
            overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.8); display: flex; align-items: center; justify-content: center; z-index: 3000;';
            overlay.innerHTML = dialogHTML;
            document.body.appendChild(overlay);
            
            overlay.onclick = (e) => {
                if (e.target === overlay) closeMaterialDialog();
            };
        }

        function toggleCustomMaterial() {
            const customInput = document.getElementById('custom-material-input');
            const select = document.getElementById('material-select');
            
            if (customInput.style.display === 'none') {
                customInput.style.display = 'block';
                select.disabled = true;
                select.style.opacity = '0.5';
            } else {
                customInput.style.display = 'none';
                select.disabled = false;
                select.style.opacity = '1';
            }
        }

        function confirmAddMaterial() {
            const select = document.getElementById('material-select');
            const amountInput = document.getElementById('material-amount');
            const customInput = document.getElementById('custom-material-name');
            const item = gameData.categories[currentCategory].items[currentItem];
            
            const amount = parseInt(amountInput.value) || 1;
            let materialName = select.value;
            
            // Check if using custom material
            if (customInput && customInput.value.trim()) {
                materialName = customInput.value.trim();
            }
            
            if (!materialName) {
                showNotification('Please select or enter a material', 'error');
                return;
            }
            
            // If it's a predefined material, expand its recipe
            const expandedRecipe = expandMaterialRecipe(materialName, amount);
            
            if (expandedRecipe) {
                // Add material with auto-calculated components
                item.crafting.direct.push({
                    name: materialName,
                    amount: amount,
                    components: expandedRecipe
                });
            } else {
                // Add as simple material without components
                item.crafting.direct.push({
                    name: materialName,
                    amount: amount
                });
            }
            
            closeMaterialDialog();
            saveToHistory();
            renderEditor();
            updateJSONPreview();
            showNotification(`Material "${materialName}" added with ${amount}x multiplier`);
        }

        function closeMaterialDialog() {
            const overlay = document.getElementById('material-dialog-overlay');
            if (overlay) overlay.remove();
        }

        function addSubMaterial(path) {
            const item = gameData.categories[currentCategory].items[currentItem];
            const parts = path.split('.');
            let target = item.crafting.direct;
            
            for (let i = 0; i < parts.length; i++) {
                if (parts[i] === 'components') {
                    target = target.components;
                } else {
                    const idx = Number(parts[i]);
                    target = target[idx];
                    if (i + 1 < parts.length && parts[i + 1] === 'components') {
                        i++;
                        target = target.components;
                    }
                }
            }
            
            if (!target.components) target.components = [];
            target.components.push({ name: 'New Component', amount: 1 });
            saveToHistory();
            renderEditor();
            updateJSONPreview();
            showNotification('Component added');
        }

        function removeMaterial(path) {
            if (!confirm('Delete material?')) return;
            
            const item = gameData.categories[currentCategory].items[currentItem];
            const parts = path.split('.');
            
            if (parts.length === 1) {
                item.crafting.direct.splice(Number(parts[0]), 1);
            } else {
                let target = item.crafting.direct;
                for (let i = 0; i < parts.length - 1; i++) {
                    if (parts[i] === 'components') {
                        target = target.components;
                    } else {
                        const idx = Number(parts[i]);
                        target = target[idx];
                        if (i + 1 < parts.length - 1 && parts[i + 1] === 'components') {
                            i++;
                            target = target.components;
                        }
                    }
                }
                
                const finalIndex = Number(parts[parts.length - 1]);
                if (parts[parts.length - 2] === 'components') {
                    target.splice(finalIndex, 1);
                } else {
                    target.components.splice(finalIndex, 1);
                }
            }
            
            saveToHistory();
            renderEditor();
            updateJSONPreview();
            showNotification('Material deleted');
        }

        function addNewItem() {
            const categoryNames = gameData.categories.map((cat, i) => `${i}: ${cat.name}`).join('\n');
            const categoryIndex = Number(prompt(`Enter category index:\n${categoryNames}`));
            if (isNaN(categoryIndex) || categoryIndex < 0 || categoryIndex >= gameData.categories.length) {
                showNotification('Invalid category index', 'error');
                return;
            }

            const newItem = {
                id: `new-item-${Date.now()}`,
                name: 'New Item',
                description: 'Description here',
                stats: {
                    stat1: { value: 50, max: 100, unit: '' }
                },
                crafting: {
                    direct: [
                        { name: 'Material 1', amount: 10 }
                    ]
                }
            };

            gameData.categories[categoryIndex].items.push(newItem);
            currentCategory = categoryIndex;
            currentItem = gameData.categories[categoryIndex].items.length - 1;
            
            saveToHistory();
            renderSidebar();
            renderEditor();
            updateJSONPreview();
            showNotification('New item created');
        }

        function duplicateCurrentItem() {
            if (currentCategory === null || currentItem === null) {
                showNotification('No item selected', 'error');
                return;
            }
            
            const original = gameData.categories[currentCategory].items[currentItem];
            const duplicate = JSON.parse(JSON.stringify(original));
            duplicate.id = `${original.id}-copy-${Date.now()}`;
            duplicate.name = `${original.name} (Copy)`;
            
            gameData.categories[currentCategory].items.push(duplicate);
            currentItem = gameData.categories[currentCategory].items.length - 1;
            
            saveToHistory();
            renderSidebar();
            renderEditor();
            updateJSONPreview();
            showNotification(`"${original.name}" duplicated`);
        }

        function addNewCategory() {
            const categoryName = prompt('Enter new category name:');
            if (!categoryName) return;
            
            const categoryId = categoryName.toLowerCase().replace(/\s+/g, '-');
            
            gameData.categories.push({
                id: categoryId,
                name: categoryName,
                items: []
            });
            
            saveToHistory();
            renderSidebar();
            updateJSONPreview();
            showNotification(`Category "${categoryName}" created`);
        }

        function deleteCurrentItem() {
            if (currentCategory === null || currentItem === null) {
                showNotification('No item selected', 'error');
                return;
            }
            if (!confirm('Really delete this item?')) return;

            const itemName = gameData.categories[currentCategory].items[currentItem].name;
            gameData.categories[currentCategory].items.splice(currentItem, 1);
            currentCategory = null;
            currentItem = null;

            document.getElementById('editor-main').innerHTML = '<div class="empty-state"><h3>Item deleted</h3><p>Select another item to edit</p></div>';
            saveToHistory();
            renderSidebar();
            updateJSONPreview();
            showNotification(`"${itemName}" deleted`);
        }

        function updateJSONPreview() {
            document.getElementById('json-preview').textContent = JSON.stringify(gameData, null, 2);
        }

        function saveData() {
            const jsonStr = JSON.stringify(gameData, null, 2);
            navigator.clipboard.writeText(jsonStr).then(() => {
                showNotification('JSON copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Failed to copy:', err);
                showNotification('Failed to copy to clipboard. Check console.', 'error');
                console.log(jsonStr); // Fallback: log to console
            });
        }

        function downloadJSON() {
            const jsonStr = JSON.stringify(gameData, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'data.json';
            a.click();
            URL.revokeObjectURL(url);
            showNotification('JSON downloaded');
        }

        loadData();
    </script>
</body>
</html>
